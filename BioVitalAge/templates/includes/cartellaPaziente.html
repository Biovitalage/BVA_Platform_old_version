<!-- 
    /CARTELLA PAZIENTE
-->

{% load static %}
<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <!-- Favicon -->
        <link rel="sortcut icon" href='{% static "image/Favicon.png" %}' type="image/x-icon">

        {% csrf_token %}
        <meta name="csrf-token" content="{{ csrf_token }}">

        <title>BVA - Cartella Paziente</title>

        <!-- Css Import -->
        <link rel="stylesheet" href="{% static 'css/Componenti.css' %}">
        <link rel="stylesheet" href="{% static 'css/cartellaPaziente.css' %}">
        <link rel="stylesheet" href="{% static 'css/homePage.css' %}">

        <!-- Bootstrap import -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">

        <!-- Font Import  -->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300..700&display=swap" rel="stylesheet">
        
        <!-- CDN IMPORT -->
    </head>

    <body>
        <!-- Loader -->
        {% include 'components/loader.html' %}

        <!-- NAVBAR -->
        {% include 'components/navBar.html' %}


        <main>
            <!-- MENU TRACE -->
            <div class="main-title-nav">

                <div class="tools-menu-trace">   
                    <div class="back-tittle">
                        <a id="back" href="{% url 'HomePage' %}"><img src="{% static 'image/Arrow_Back.png' %}"></a>
                    </div>
                    <button title="Prescrione esami"><img src="{% static 'image/Esame_grey.png' %}" alt=""></button> <!-- esami -->
                    <button title="Prescrione farmaci"><img src="{% static 'image/Farmaci.png' %}" alt=""></button> <!-- farmaci -->
                    <button title="Prescrione libera"><img src="{% static 'image/Foglio.png' %}" alt=""></button> <!-- libera -->
                    <button title="Prescrione certificati"><img src="{% static 'image/Certificato.png' %}" alt=""></button> <!-- certificati -->
                </div>
            
                <div class="tools-container-left-side" style="display: flex; justify-content: center; align-items: center; width: 28rem">

                    <div class="tools-menu-trace">   
                        <button title="Anamnesi"><img src="{% static 'image/Anamnesi_gray.png' %}" alt=""></button> 
                        <button title="Esame Obbiettivo"><img src="{% static 'image/EsameObbiettivo.png' %}" alt=""></button> 
                        <button title="Problemi"><img src="{% static 'image/Problemi.png' %}" alt=""></button> 
                    </div>

                    <div class="main-menu-trace">
                        <a href="{% url 'HomePage' %}">
                            <img src="{% static 'image/Home.png' %}" alt="Home Page" title="Home Page" />
                        </a>
                        <p>»</p>
                        <p class="breadcrumb">Cartella Paziente</p>
                    </div>

                </div>

                
            </div>  

            <!-- MESSAGGIO DI SUCCESSO CON PUNTEGGIO -->
            {% if success or errore %}
            <script>
                    document.addEventListener("DOMContentLoaded", () => {
                        setTimeout(() => {
                            const modal = document.getElementById("modal_message");
                            if (modal) {
                                modal.style.transition = "opacity 0.3s ease";
                                modal.style.opacity = "0";
                                setTimeout(() => modal.remove(), 500); // rimuove dal DOM dopo fade out
                            }
                        }, 4000); // tempo in millisecondi prima che scompaia (4s)
                    });
            </script>
            {% endif %}

            {% if success %}
            <div class="success_message" id="modal_message">

                    <div class="header_message">
                        <div class="contianer-title">
                            <img src="{% static 'image/Success.png' %}" alt="">
                            <p class="title_message">Success!</p>
                        </div>
                        <button class="close" onclick="closeModal()">x</button>
                        
                    </div>

                    <p>I dati delle informazioni personali sono state correttamente aggiornate!</p>

            </div>  
            {% endif %}

            <!-- MESSAGGIO ERRORE -->
            {% if errore %}
            <div class="erorre_message" id="modal_message">
        
                        <div class="header_message">
                            <div class="contianer-title">
                                <img src="{% static 'includes/images/unsuccess.png' %}" alt="">
                                <p class="title_message_errore">Errore!</p>
                            </div>
                            <button class="close" onclick="closeModal()">x</button>
                            
                        </div>
                        <p>Sembra che qualcosa sia andato storto.</p>
                        <p style="margin-top: -1rem; color: #c74b5b; font-weight: bold;">X {{ errore }}</p>
                    
            </div>
            {% endif %}

            <!-- Backdrop -->
            <div class="backdrop-indici" id="backdropIndici"></div>
            
            {% include 'dynamic_templates/cartella_paziente/modale_salute_cuore.html' %}
            {% include 'dynamic_templates/cartella_paziente/modale_salute_del_rene.html' %}
            {% include 'dynamic_templates/cartella_paziente/modale_salute_epatica.html' %}
            {% include 'dynamic_templates/cartella_paziente/modale_salute_cerebrale.html' %}
            {% include 'dynamic_templates/cartella_paziente/modale_salute_ormonale.html' %}
            {% include 'dynamic_templates/cartella_paziente/modale_salute_del_sangue.html' %}
            {% include 'dynamic_templates/cartella_paziente/modale_salute_del_sistema_immunitario.html' %}

            <div class="backdrop-modale-note" id="backdropModaleNote"></div>

            <!-- MODALE NOTE -->
            <div class="modale-note" id="modale_note">
                <form method="POST" action="{% url 'cartellaPaziente_note' persona.id %}">
                    {% csrf_token %}
                    <h3>Note Patologie Paziente</h3>

                    <textarea name="note_patologie" id="text_area" placeholder="{{ persona.note_patologie | default:'Inserisci qui la nota testuale' }}"></textarea>

                    <div class="modale-button">

                        <button type="button" class="button" id="modify-btn-note">modify</button>

                        <div class="sub-div-button">
                            <button type="submit" class="button" id="save">save</button>
                            <button type="button" class="button" id="close">close</button>
                        </div>

                    </div>
                </form>
            </div>

            <!-- MODALE INFORMAZIONI PERSONALI -->  
            <div class="container-informazioni-personali">
                
                <form id="personaForm" method="POST" action="{% url 'cartella_paziente' persona.id %}">
                    {% csrf_token %}

                    <div class="container-header-informazioni">

                        <div class="container-header-info">
                            <div class="container-dati-anagrafici">
                                <div class="img-circle-container">
                                    <img src="{% static 'image/Dati_angrafici.png' %}" alt="">
                                </div>
                                <h3>{{ persona.name }} {{ persona.surname }}</h3>   
                            </div>    
                        </div>
            
                        <div class="header-tools">

                            <button type="button" id="modale-note">
                                <img src="{% static 'image/Note.png' %}" alt="Note" title="Note">
                            </button>
                    
                            <a href="{% static 'includes/pdfTemplates/Privacy&Policy.pdf' %}" download class="privacy-icon">
                                <img src="data:image/png;base64,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" alt="data-protection" title="Privacy & Policy">
                            </a>      
                        
                            <!-- <button type="button" class="button" id="edit_btn">
                                <span class="button__icon-wrapper">
                                    
                                    <svg xmlns="http://www.w3.org/2000/svg"
                                        viewBox="0 0 24 24"
                                        fill="none"
                                        width="18"
                                        class="button__icon-svg">
                                    <path d="M4 17.25V21h3.75L18.81 9.94l-3.75-3.75L4 17.25z"
                                            stroke="currentColor"
                                            stroke-width="2"
                                            stroke-linecap="round"
                                            stroke-linejoin="round"/>
                                    <path d="M20.71 7.04a1.003 1.003 0 0 0-1.42 0l-2.34 2.34 3.75 3.75 2.34-2.34a1.003 1.003 0 0 0 0-1.42l-2.33-2.33z"
                                            stroke="currentColor"
                                            stroke-width="2"
                                            stroke-linecap="round"
                                            stroke-linejoin="round"/>
                                    </svg>

                                
                                    <svg xmlns="http://www.w3.org/2000/svg"
                                        viewBox="0 0 24 24"
                                        fill="none"
                                        width="18"
                                        class="button__icon-svg button__icon-svg--copy">
                                    <path d="M4 17.25V21h3.75L18.81 9.94l-3.75-3.75L4 17.25z"
                                            stroke="currentColor"
                                            stroke-width="2"
                                            stroke-linecap="round"
                                            stroke-linejoin="round"/>
                                    <path d="M20.71 7.04a1.003 1.003 0 0 0-1.42 0l-2.34 2.34 3.75 3.75 2.34-2.34a1.003 1.003 0 0 0 0-1.42l-2.33-2.33z"
                                            stroke="currentColor"
                                            stroke-width="2"
                                            stroke-linecap="round"
                                            stroke-linejoin="round"/>
                                    </svg>
                                </span>
                                <span class="btn-text">Edita</span>
                            </button>

                            <button type="button" id="cancel_btn" class="button hidden">
                                <span class="btn-text">Annulla</span>
                            </button> -->
                            
                            <button type="button" class="button" id="base_btn" onclick="window.location.href='{% url 'dati_base' persona.id %}'">
                                <span class="button__icon-wrapper">
                            
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" width="18" class="button__icon-svg">
                                    <path d="M9 6l6 6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>

                            
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" width="18" class="button__icon-svg button__icon-svg--copy">
                                    <path d="M9 6l6 6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>

                                </span>
                                Dati Base Paziente
                            </button>
                        </div>

                    </div>
 
                    <div class="container_box">

                        <div class="grid-container">

                            <div class="field">
                                <p class="field-title">Età:</p>
                                <p>{{ persona.chronological_age |default:'non inserito' }}</p>
                            </div>

                            <div class="field">
                                <p class="field-title">Codice Fiscale:</p>
                                <p>{{ persona.codice_fiscale|default:'non inserito' }}</p>
                            </div>

                            <div class="field">
                                <p class="field-title">Data di Nascita:</p>
                                <p>{{ persona.dob|date:'d/m/Y'|default:'non inserito' }}</p>
                            </div>
                        
                            <div class="field">
                                <p class="field-title">Città di residenza:</p>
                                <p>{{ persona.residence|default:'non inserito' }}, {{ persona.cap|default:'non inserito' }}, {{ persona.province|default:'non inserito' }}</p>
                            </div>

                            <div class="field">
                                <p class="field-title">Genere:</p>
                                <p>{{ persona.gender|default:'non inserito' }}</p>
                            </div>

                            <!-- <div class="field">
                                <p class="field-title">Gruppo Sanguigno:</p>
                                <p>{{ persona.blood_group|default:'non inserito' }}</p>
                            </div> -->
                        </div>

                        <div class="footer-container">
                            <div class="subCard-container">
                            
                                <!-- <div class="card-subcard">

                                    <div class="img-circle-container">
                                        <img src="{% static 'image/Stetoscopio.png' %}" alt="">
                                    </div>

                                    <div class="container-input-info">
                                        <p>Dottore Associato</p>

                                        {% if is_secretary %}
                                        <span id="associate-display" class="type-two">
                                            {{ persona.dottore.nome|title }} {{ persona.dottore.cognome|title }}
                                        </span>


                                        <select id="associate-select" name="dottore" class="type-two" style="display:none">
                                            <option value="">Seleziona Dottore</option>
                                            {% for doc in dottori %}
                                            <option value="{{ doc.id }}"
                                                {% if persona.dottore and persona.dottore.id == doc.id %}selected{% endif %}>
                                                {{ doc.nome|title }} {{ doc.cognome|title }}
                                            </option>
                                            {% endfor %}
                                        </select>

                                        {% else %}
                                        <span id="associate-display" class="type-two input-disabled">
                                            {{ persona.dottore.nome|title }} {{ persona.dottore.cognome|title }}
                                        </span>
                                        {% endif %}

                                    </div>

                                </div> -->

                                <!-- <div class="card-subcard">
                                    <div class="img-circle-container">
                                        <img src="{% static 'image/Ospedale.png' %}" alt="">
                                    </div>
                                    <div class="container-input-info">
                                        <p>Visita Recente</p>
                                        <span class="type-two cursor-not-allowed">
                                        {% if ultimo_appuntamento %}{{ ultimo_appuntamento.data|date:"d/m/Y" }}
                                        {% else %}non presente.{% endif %}
                                        </span>
                                    </div>
                                </div> -->

                                <div class="card-subcard">
                                <div class="img-circle-container">
                                    <img src="{% static 'image/Calendario.png' %}" alt="">
                                </div>
                                <div class="container-input-info">
                                    <p>Prossima Visita</p>
                                    <span class="type-two cursor-not-allowed">
                                    {% if prossimo_appuntamento %}{{ prossimo_appuntamento.data|date:"d/m/Y" }}
                                    {% else %}non presente.{% endif %}
                                    </span>
                                </div>
                                </div>
                            </div>

                            <div class="Contact-Container">
                                
                                <div class="card-subcard">
                                    <div class="img-circle-container">
                                        <img src="{% static 'image/Email_Violet.png' %}" alt="">
                                    </div>
                                    <div class="container-input-info">
                                        <p>Email</p>
                                        <span>{{ persona.email|default:'non inserito' }}</span>
                                    </div>
                                </div>

                                <div class="card-subcard">
                                    <div class="img-circle-container">
                                        <img src="{% static 'image/Phone.png' %}" alt="">
                                    </div>
                                    <div class="container-input-info">
                                        <p>Telefono</p>
                                        <span>{{ persona.phone|default:'non inserito' }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>

            </div>

            <div class="flex-container">

                <div class="container-tabella" style="width: 50%;">

                    <div class="container-header-diario">
                        <h3>Diario Clinico</h3>
                        <div class="header-container">
                            <button class="button active">Diario</button>
                            <button class="button">Farmaci</button>
                            <button class="button">Accertamenti</button>
                            <button class="button">Certificati</button>
                        </div>
                    </div>
                       
                    <div class="container-content">
                        <div class="header-table">
                            <div class="header-cella">
                                <p>Data</p>
                            </div>
                            <div class="header-cella">
                                <p>Descrizione</p>
                            </div>
                            <div class="header-cella">
                                <p>Diagnosi</p>
                            </div>
                            <div class="header-cella">
                                <p>Nota</p>
                            </div>
                        </div>

                        <div class="container-table">

                            <div class="row-table">
                                <div class="row-cella">
                                    <p>02/07/2025</p>
                                </div>
                                <div class="row-cella">
                                    <p>Xanax</p>
                                </div>
                                <div class="row-cella">
                                    <p>depressione</p>
                                </div>
                                <div class="row-cella">
                                    <p>nota testuale</p>
                                </div>
                            </div>

                            <div class="row-table">
                                <div class="row-cella">
                                    <p>02/07/2025</p>
                                </div>
                                <div class="row-cella">
                                    <p>emocromo e urino cultura</p>
                                </div>
                                <div class="row-cella">
                                    <p>infezione</p>
                                </div>
                                <div class="row-cella">
                                    <p>nota testuale</p>
                                </div>
                            </div>

                            <div class="row-table">
                                <div class="row-cella">
                                    <p>02/07/2025</p>
                                </div>
                                <div class="row-cella">
                                    <p>buona salute</p>
                                </div>
                                <div class="row-cella">
                                    <p>costituzione</p>
                                </div>
                                <div class="row-cella">
                                    <p>nota testuale</p>
                                </div>
                            </div>                          
                        </div>
                        
                        <div class="pagination_tabella">
                        
                            {% if storico_page.has_previous %}
                            <a class="previous" href="?page={{ storico_page.previous_page_number }}">Previous</a>
                            {% else %}
                            <span class="previous disabled">Previous</span>
                            {% endif %}
                    
                            {% for num in storico_page.paginator.page_range %}
                            {% if storico_page.number == num %}
                            <span class="current">{{ num }}</span>
                            {% else %}
                            <a href="?page={{ num }}">{{ num }}</a>
                            {% endif %}
                            {% endfor %}
                    
                            {% if storico_page.has_next %}
                            <a class="next" href="?page={{ storico_page.next_page_number }}">Next</a>
                            {% else %}
                            <span class="next disabled">Next</span>
                            {% endif %}
                    
                        </div>
                    </div>
                </div>

                <div class="container-list" style="width: 30%;">
                    <h3>Fattori di Rischio Prevenzione</h3>
                    <div class="container-test">

                        <div class="scrollable-content">
                            <p>allergie</p>
                            <p>reazione avverse ai farmaci</p>
                            <p>allergie</p>
                            <p>reazione avverse ai farmaci</p>
                            <p>allergie</p>
                            <p>reazione avverse ai farmaci</p>
                            <p>allergie</p>
                            <p>reazione avverse ai farmaci</p>
                            <p>allergie</p>
                            <p>reazione avverse ai farmaci</p>
                            <p>allergie</p>
                            <p>reazione avverse ai farmaci</p>
                        </div>

                        <div class="scrollable-content">
                            <p>test</p>
                            <p>test</p>
                            <p>test</p>
                            <p>test</p>
                            <p>test</p>
                            <p>test</p>
                            <p>test</p>
                            <p>test</p>
                            <p>test</p>
                            <p>test</p>
                        </div>
                    </div>
                
                </div>

                <div class="container-list" style="width: 20%">
                    <h3>Problemi</h3>
                    <div class="scrollable-content" style="width: 100%;">
                        <p style="text-align: center; border-bottom: none; margin-top: 2rem;">Nessun Problema riscontrato</p>
                    </div>
                </div>
            </div>

            <!-- TABELLA DIARIO CLINICO -->

            

            <!-- CONTAINER STORICO -->
            <div class="container-flex-layout">
                
                <div class="container-info">

                    <div class="container-titolo">
                        <img src="{% static 'image/Info.png' %}" alt="">
                        <h3>Informazioni Generali</h3>
                    </div>
                    
                </div>

                <div class="container-storico">

                    <div class="card-storico" onclick="window.location.href='{% url 'storico' persona.id %}'">
                        <div class="img-circle-container">
                            <img src="{% static 'image/Storico_color.png' %}" alt="">
                        </div>
                        <a href="{% url 'storico' persona.id %}">
                        <span class="freccia">&larr;</span> Storico
                        </a>
                    </div>

                    <div class="card-storico" onclick="window.location.href='{% url 'diagnosi' persona.id %}'">
                        <div class="img-circle-container">
                            <img src="{% static 'image/Diagnosi_color.png' %}" alt="">
                        </div>
                        
                        <a href="{% url 'diagnosi' persona.id %}">
                        <span class="freccia">&larr;</span> Diagnosi
                        </a>
                    </div>

                    <div class="card-storico">
                        <div class="img-circle-container">
                            <img src="{% static 'image/Terapie_color.png' %}" alt="">
                        </div>
                        <a href="{% url 'terapie' persona.id %}">
                        <span class="freccia">&larr;</span> Terapie
                        </a>
                    </div>

                    <div class="card-storico">
                        <div class="img-circle-container">
                            <img src="{% static 'image/Esame_color.png' %}" alt="">
                        </div>
                        <a href="{% url 'esami' persona.id %}">
                        <span class="freccia">&larr;</span> Esami
                        </a>
                    </div>

                    <div class="card-storico">
                        <div class="img-circle-container">
                            <img src="{% static 'image/Visite_color.png' %}" alt="">
                        </div>
                        <a href="{% url 'visite' persona.id %}">
                        <span class="freccia">&larr;</span> Visite
                        </a>
                    </div>

                    <div class="card-storico">
                        <div class="img-circle-container">
                            <img src="{% static 'image/Allegati_color.png' %}" alt="">
                        </div>
                        <a href="{% url 'allegati' persona.id %}">
                        <span class="freccia">&larr;</span> Allegati
                        </a>
                    </div>

                </div>

            </div>
        
            <!-- Indicatori di performance -->
            <div class="container-indicatori containerStyle">

                <div class="card card4" id="card-style">
                    <h3 class="section-tittle">Indicatori di performance</h3>

                    <div class="score-clock-graph">
                    
                        <div class="container-clock cardIndici"
                            id="cardClick"
                            card-name="Salute del Cuore"
                            img-card="{% static 'image/Heart_Colorato.png' %}"
                            dict-value="Cuore"                   
                            >

                            <svg class="progress-ring" width="140" height="140">
                                <circle class="progress-ring__background" cx="70" cy="70" r="65"></circle>
                                <circle class="progress-ring__progress" id="heartClock" cx="70" cy="70" r="65" marker-end="url(#endDot)"></circle>
                            </svg>
                        
                            
                            <div class="percentage" id="heartPercentage"></div>
                            
                            <div class="descrizione-clock">
                                <img src="{% static 'image/Heart_Colorato.png' %}" alt="">
                                <p>Salute del Cuore</p>
                            </div>
                        </div>  
                        
                        <div class="container-clock cardIndici" 
                            id="cardClick" 
                            card-name="Salute Renale"
                            img-card="{% static 'image/Reni.png' %}"
                            dict-value="Renale">

                            <svg class="progress-ring" width="140" height="140">
                                <circle class="progress-ring__background" cx="70" cy="70" r="65"></circle>
                                <circle class="progress-ring__progress" id="kidneyClock" cx="70" cy="70" r="65" marker-end="url(#endDot)"></circle>
                            </svg>
                        
                            <div class="percentage" id="kidneyPercentage"></div>
                        
                            <div class="descrizione-clock">
                                <img src="{% static 'image/Reni.png' %}" alt="">
                                <p>Salute Renale</p>
                            </div>
                        </div>
                         
                        <div class="container-clock cardIndici"
                            id="cardClick"
                            card-name="Salute Epatica"
                            img-card="{% static 'image/Fegato.png' %}"
                            dict-value="Epatica">
                            <svg class="progress-ring" width="140" height="140">
                                <circle class="progress-ring__background" cx="70" cy="70" r="65"></circle>
                                <circle class="progress-ring__progress" id="liverClock" cx="70" cy="70" r="65" marker-end="url(#endDot)"></circle>
                            </svg>

                            <div class="percentage" id="liverPercentage"></div>
                        
                            <div class="descrizione-clock">
                                <img src="{% static 'image/Fegato.png' %}" alt="">
                                <p>Salute Epatica</p>
                            </div>
                        </div>    
            
                        <div class="container-clock cardIndici"
                            id="cardClick"
                            card-name="Salute Cerebrale" 
                            img-card="{% static 'image/Cervello.png' %}"
                            dict-value="Cerebrale">
                            <svg class="progress-ring" width="140" height="140">
                                <circle class="progress-ring__background" cx="70" cy="70" r="65"></circle>
                                <circle class="progress-ring__progress" id="brainClock" cx="70" cy="70" r="65" marker-end="url(#endDot)"></circle>
                            </svg>

                            <div class="percentage" id="brainPercentage"></div>
                        
                            <div class="descrizione-clock">
                                <img src="{% static 'image/Cervello.png' %}" alt="">
                                <p>Salute Cerebrale</p>
                            </div>
                        </div>
                                  
                        <div class="container-clock cardIndici" 
                            id="cardClick"
                            card-name="Salute Ormonale"
                            img-card="{% static 'image/Cellula.png' %}"
                            dict-value="Ormonale">
                            <svg class="progress-ring" width="140" height="140">
                                <circle class="progress-ring__background" cx="70" cy="70" r="65"></circle>
                                <circle class="progress-ring__progress" id="hormoneClock" cx="70" cy="70" r="65" marker-end="url(#endDot)"></circle>
                            </svg>

                            <div class="percentage" id="hormonePercentage"></div>
                            
                            <div class="descrizione-clock">
                                <img src="{% static 'image/Cellula.png' %}" alt="">
                                <p>Salute Ormonale</p>
                            </div>
                        </div>                
        
                        <div class="container-clock cardIndici"
                            id="cardClick" 
                            card-name="Salute del Sangue"
                            img-card="{% static 'image/Blood_Colorato.png' %}"
                            dict-value="Sangue">
                            <svg class="progress-ring" width="140" height="140">
                                <circle class="progress-ring__background" cx="70" cy="70" r="65"></circle>
                                <circle class="progress-ring__progress" id="bloodClock" cx="70" cy="70" r="65" marker-end="url(#endDot)"></circle>
                            </svg>

                            <div class="percentage" id="bloodPercentage"></div>
                            
                            <div class="descrizione-clock">
                                <img src="{% static 'image/Blood_Colorato.png' %}" alt="">
                                <p>Salute del Sangue</p>
                            </div>
                        </div>
                    
                        <div class="container-clock cardIndici" style="gap: 15px;" 
                            card-name="Salute del Sistema Immunitario"
                            img-card="{% static 'image/Sistema.png' %}"
                            dict-value="Immunitario">
                            <svg class="progress-ring" width="140" height="140">
                                <circle class="progress-ring__background" cx="70" cy="70" r="65"></circle>
                                <circle class="progress-ring__progress" id="immuneClock" cx="70" cy="70" r="65" marker-end="url(#endDot)"></circle>
                            </svg>

                            <div class="percentage" id="immunePercentage" style="margin-top: 5px;"></div>
                        
                            <div class="descrizione-clock" style="margin-bottom: -14px;">
                                <img src="{% static 'image/Sistema.png' %}" alt="">
                                <p style="max-width: 60%; font-size: 14px;">Salute del Sistema Immunitario</p>
                            </div>
                        </div>
                                  
                        <div class="container-clock" onclick="window.location.href ='{% url 'microbiota_detail' persona.id %}'" style="cursor: pointer; height: 280px;">
                            <svg class="progress-ring" width="140" height="140">
                                <circle class="progress-ring__background" cx="70" cy="70" r="65"></circle>
                                <circle class="progress-ring__progress" id="muscleClock" cx="70" cy="70" r="65" marker-end="url(#endDot)"></circle>
                            </svg>

                            <div class="percentage" id="musclePercentage" style="margin-top: 5px;"></div>
                    
                            <div class="descrizione-clock" style="margin-top: 5px;">
                                <img src="{% static 'image/Microbiota.png' %}" alt="">
                                
                                <a style="text-decoration: none; color: #3a255d;" href="{% url 'microbiota_detail' persona.id %}">Microbiota</a>
                            
                            </div>
                        </div>
                    </div>

                    <div class="container-second-row">

                        <div class="capacita_vitale" data-punteggio="{{ punteggio_eta_metabolica|default:'2' }}">
                            <a href="{% url 'composizione' persona.id %}" style="text-decoration: none; color: inherit;" title="Età Metabolica">
                                <h3>Età Metabolica</h3>
                                <div class="card-polmone">
                                    <div class="backdrop-riempimento">
                                        <svg class="ondina" viewBox="0 0 500 100" preserveAspectRatio="none">
                                            <path class="wavePath" d="M0,30 C150,80 350,0 500,40 L500,100 L0,100 Z" />
                                        </svg>
                                    </div>
                                    <img src="{% static 'image/Eta_Metabolica.png' %}" alt="" width="120px" height="120px">
                                </div>
                                <p class="descrizione-vitale"><strong>Punteggio:</strong> {{ punteggio_eta_metabolica|default:'n.a.' }} / 100</p>
                            </a>
                        </div>

                        <div class="capacita_vitale" data-punteggio="{{ ultimo_referto_capacita_vitale.punteggio|default:'2' }}">
                            <a href="{% url 'etaVitale' persona.id %}" style="text-decoration: none; color: inherit;" title="Capacità Vitale">
                                <h3>Capacità Vitale</h3>
                        
                                <div class="card-polmone">
                                    <div class="backdrop-riempimento">
                                        <svg class="ondina" viewBox="0 0 500 100" preserveAspectRatio="none">
                                            <path class="wavePath" d="M0,30 C150,80 350,0 500,40 L500,100 L0,100 Z" />
                                        </svg>
                                    </div>
                                    
                                    <img src="{% static 'image/Capacita_Vitale.png' %}" alt="" width="120px" height="120px">
                                </div>
                                
                                <p class="descrizione-vitale"><span style="font-weight: bold;">Punteggio: &nbsp; </span>{{ ultimo_referto_capacita_vitale.punteggio|default:'n.a.' }} / 10</p>
                            </a>

                        </div>

                        <div class="capacita_vitale" data-punteggio="{{ referti_test_recenti.resilienza|default:'2' }}">
                            <a href="{% url 'resilienza' persona.id %}" style="text-decoration: none; color: inherit;" title="Resilienza">
                                <h3>Resilienza</h3>
                                <div class="card-polmone">
                                    <div class="backdrop-riempimento">
                                        <svg class="ondina" viewBox="0 0 500 100" preserveAspectRatio="none">
                                            <path class="wavePath" d="M0,30 C150,80 350,0 500,40 L500,100 L0,100 Z" />
                                        </svg>
                                    </div>
                                    <img src="{% static 'image/Resilienza.png' %}" alt="" width="120px" height="120px">
                                </div>
                                <p class="descrizione-vitale"><strong>Punteggio:</strong> {{ referti_test_recenti.resilienza|default:'n.a.' }}</p>
                            </a>
                        </div>

                        <div class="capacita_vitale" data-punteggio="{{ referti_test_recenti.resilienza|default:'2' }}">
                            <a href="{% url 'eta_biologica' persona.id %}" style="text-decoration: none; color: inherit;" title="Resilienza">
                                <h3>Età Biologica</h3>
                                <div class="card-polmone">
                                    <div class="backdrop-riempimento">
                                        <svg class="ondina" viewBox="0 0 500 100" preserveAspectRatio="none">
                                            <path class="wavePath" d="M0,30 C150,80 350,0 500,40 L500,100 L0,100 Z" />
                                        </svg>
                                    </div>
                                    <img src="{% static 'image/Eta_biologica2.png' %}" alt="" width="120px" height="120px">
                                </div>
                                <p class="descrizione-vitale"><strong>Punteggio:</strong> {{ referti_test_recenti.resilienza|default:'n.a.' }}</p>
                            </a>
                        </div>

                        <div class="capacita_vitale" data-punteggio="{{ referti_test_recenti.resilienza|default:'2' }}">
                            <a href="{% url 'resilienza' persona.id %}" style="text-decoration: none; color: inherit;" title="Resilienza">
                                <h3>Età Neurocognitiva</h3>
                                <div class="card-polmone">
                                    <div class="backdrop-riempimento">
                                        <svg class="ondina" viewBox="0 0 500 100" preserveAspectRatio="none">
                                            <path class="wavePath" d="M0,30 C150,80 350,0 500,40 L500,100 L0,100 Z" />
                                        </svg>
                                    </div>
                                    <img src="{% static 'image/Eta_neurologica.png' %}" alt="" width="120px" height="120px">
                                </div>
                                <p class="descrizione-vitale"><strong>Punteggio:</strong> {{ referti_test_recenti.resilienza|default:'n.a.' }}</p>
                            </a>
                        </div>
                
                        <div class="capacita_vitale" data-punteggio="{{ referti_test_recenti.microbiota|default:'2' }}" onclick="window.location.href = '{% url 'valutazione_m_s' persona.id %}' " style="cursor: pointer;" title="Età Muscolo Scheletrica">
                            <h3 id="small_title">Età Muscolo Scheletrica</h3>
                            <div class="card-polmone">
                                <div class="backdrop-riempimento">
                                    <svg class="ondina" viewBox="0 0 500 100" preserveAspectRatio="none">
                                        <path class="wavePath" d="M0,30 C150,80 350,0 500,40 L500,100 L0,100 Z" />
                                    </svg>
                                </div>
                                <img src="{% static 'image/Muscolo.png' %}" alt="" width="120px" height="120px">
                            </div>
                            <p class="descrizione-vitale"><strong>Punteggio:</strong> {{ referti_test_recenti.microbiota|default:'n.a.' }}</p>
                        </div>
                    </div>
                </div>
                
            </div> 
        </main>


        <!-- SCRIPT SCORE -->
        <script>
            // Anima un singolo cerchio di progresso
            function animateClock(clockId, percentageId, targetPercentage) {
                const clock = document.getElementById(clockId);
                const pctEl = document.getElementById(percentageId);
                if (!clock || !pctEl) return;

                const radius = clock.r.baseVal.value;
                const circumference = 2 * Math.PI * radius;
                const pct = Math.min(Math.max(targetPercentage, 0), 100);
                const offset = ((100 - pct) / 100) * circumference;

                // 1) imposta dasharray
                clock.style.strokeDasharray = `${circumference} ${circumference}`;

                // 2) disabilita la transizione per il "reset"
                clock.style.transition = 'none';
                clock.style.strokeDashoffset = circumference;

                // 3) forza il reflow per essere sicuri che il reset sia applicato subito
                clock.getBoundingClientRect();

                // 4) con un tick riattiva la transizione e porta al valore corretto
                setTimeout(() => {
                    clock.style.transition = 'stroke-dashoffset 0.35s ease-in-out';
                    clock.style.strokeDashoffset = offset;
                }, 50);

                // 5) aggiorna la percentuale testuale
                pctEl.textContent = `${pct}%`;
            }

        
            // Genera i grafici (invariato)
        

        
            // Al caricamento della pagina, anima tutti i clock e genera i grafici
            document.addEventListener("DOMContentLoaded", () => {
            animateClock("heartClock",    "heartPercentage",    {{ score.Cuore }});
            animateClock("kidneyClock",   "kidneyPercentage",   {{ score.Reni }});
            animateClock("liverClock",    "liverPercentage",    {{ score.Fegato }});
            animateClock("brainClock",    "brainPercentage",    {{ score.Cervello }});
            animateClock("hormoneClock",  "hormonePercentage",  {{ score.Sistema_Ormonale }});
            animateClock("bloodClock",    "bloodPercentage",    {{ score.Sangue }});
            animateClock("immuneClock",   "immunePercentage",   {{ score.Sistema_Immunitario }});
            animateClock("muscleClock",   "musclePercentage",   75);
        
                // Chart 1: Livello BP
                generateChart(
                document.getElementById("chart1").getContext("2d"),
                [2, 4, 6],
                "Insulina"
                );

                // Chart 2: Glicemia (ultime 3 visite: 110,95,140)
                generateChart(
                document.getElementById("chart2").getContext("2d"),
                [110, 95, 140],
                "Glicemia"
                );

                // Chart 3: Emoglobina (ultime 3 visite: 22,26,28)
                generateChart(
                document.getElementById("chart3").getContext("2d"),
                [22, 26, 28],
                "Emoglobina"
                );

                // Chart 4: Colesterolo (ultime 3 visite: 260,280,255)
                generateChart(
                document.getElementById("chart4").getContext("2d"),
                [260, 280, 255],
                "Colesterolo"
                );
            });
        </script>

        <!-- SCRIPT CAPACITA' VITALE -->
        <script>
            document.addEventListener("DOMContentLoaded", () => {
                const wave1 = "M0,40 C150,100 350,-20 500,60 L500,100 L0,100 Z";
                const wave2 = "M0,60 C150,40 350,120 500,30 L500,100 L0,100 Z";
            
                document.querySelectorAll(".capacita_vitale").forEach(card => {
                    // Ottieni il punteggio, oppure assegna 1 se mancante (10%)
                    const punteggio = parseFloat(card.dataset.punteggio);
                    const punteggioFinale = isNaN(punteggio) ? 1 : punteggio;
            
                    // Se il punteggio è maggiore di 10, è in base 100, altrimenti in base 10
                    const percentuale = punteggioFinale > 10 
                        ? Math.min(punteggioFinale, 100) 
                        : Math.min((punteggioFinale / 10) * 100, 100);
            
                    const backdrop = card.querySelector(".backdrop-riempimento");
                    const wavePath = card.querySelector(".wavePath");
            
                    if (!wavePath || !backdrop) return;
            
                    // Animazione ondina
                    gsap.to(wavePath, {
                        duration: 2,
                        repeat: -1,
                        yoyo: true,
                        ease: "sine.inOut",
                        attr: { d: wave2 }
                    });
            
                    // Altezza riempimento
                    gsap.to(backdrop, {
                        duration: 1.8,
                        height: `${percentuale}%`,
                        ease: "power2.out"
                    });
                });
            });
        </script>

        <!-- IMPORT JS PRE DOBY CLOSE TAG -->
        <script src="{% static 'js/cartellaPaziente.js' %}" type="module"></script>
        
        <!--  CLOSE MODALE MESSAGE SUCCESS -->
        <script>
            function closeModal(){
                const modale = document.getElementById('modal_message');
                modale.style.display = 'none';
            }
        </script>

        <!-- CDN import -->
        <script src="https://cdn.jsdelivr.net/npm/docx@7.7.0/build/index.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/8.0.2/docx.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    </body>
</html>